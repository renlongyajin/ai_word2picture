# 🧠 AI 创意图像助手开发计划

## 1. 项目目标与成功标准
- 提供稳定可扩展的文生图、图生图以及 Prompt 优化一体化工具，满足创意图像快速生成需求。
- 面向 RTX 3060 级别硬件，完成 FP16、xFormers、VAE Tiling 等推理优化，实现单张 512×512 图像 < 6 秒。
- 构建 Gradio 网页前端，支持文本输入、图像上传、风格预设、历史记录与结果下载。
- 通过 Claude/GPT 接口实现 Prompt 自动优化，目标是让优化后结果满意度相较原始 Prompt 提升 20%。
- 交付完整文档、测试报告、演示素材，并支持后续拓展（LoRA、Inpainting 等）。

## 2. 开发里程碑与时间安排（4 周）

| 周期 | 目标阶段 | 关键任务 | 里程碑交付物 |
|------|----------|----------|--------------|
| 第 1 周 | 环境与文生图基础 | 建立 Conda 环境；下载 SDXL Turbo；实现 `Text2ImageService` 与基础 CLI/Gradio Demo；编写初始单元测试 | 文生图最小可用 Demo、`tests/test_text2img.py` |
| 第 2 周 | 图生图与 ControlNet | 接入 ControlNet Canny/Depth；实现 `Image2ImageService`、`ControlNetManager`；完成图生图 UI 交互；补充测试图集 | 图生图 Demo、`tests/test_img2img.py` |
| 第 3 周 | Prompt 优化与风格模板 | 接入 Claude/GPT API；实现 `PromptOptimizer`、`StylePresetRegistry`；完成多选风格 UI；建立日志与历史记录 | 端到端 Demo、`tests/test_prompt_optimizer.py` |
| 第 4 周 | 性能优化与演示准备 | 集成性能开关；补齐异常处理、缓存、配置管理；完善 README、操作指引、演示脚本与视频草稿 | 发布候选版本、文档与演示素材 |

> 每周末组织一次集成回归测试，确保所有模块在主干分支（`main`）上稳定运行。

## 3. 系统架构概述
1. **启动层（`app.py`）**：读取配置、初始化模型服务与 UI 布局、启动 Gradio 服务器。
2. **服务层（`modules/pipelines/*.py`）**：封装文生图、图生图、ControlNet 推理逻辑，以统一接口供 UI 调用。
3. **业务辅助层（`modules/optimization`, `modules/services`）**：处理 Prompt 优化、风格模板、历史记录、缓存与文件管理。
4. **UI 层（`modules/ui/*.py`）**：定义 Gradio 组件、交互回调逻辑、会话状态管理。
5. **公共工具层（`modules/utils/*.py`）**：提供图像处理、日志、异常封装、任务分发等通用函数。
6. **配置与资源层（`config/`, `assets/`）**：集中管理密钥、模型路径、风格模板、示例资产。

整体数据流：用户输入 → UI 触发回调 → Prompt 优化（可选）→ 模型服务生成 → 输出处理 → UI 展示与存档。

## 4. 文件组织结构规划

```
AI_word2picture/
├── app.py                        # Gradio 入口，加载配置与路由回调
├── config/
│   ├── __init__.py
│   ├── settings.py               # AppConfig 定义、环境变量加载
│   └── secrets.example.yaml      # API Key/模型路径示例
├── requirements.txt
├── README.md
├── 开发计划.md
├── 项目计划书.md
├── assets/
│   ├── prompts/                  # Prompt 示例与风格模板
│   ├── samples/                  # 演示输出图像
│   └── styles.json               # 风格定义数据
├── logs/
│   └── .gitkeep                  # 运行日志输出目录
├── models/
│   └── README.md                 # 模型下载指引
├── modules/
│   ├── __init__.py
│   ├── pipelines/
│   │   ├── __init__.py
│   │   ├── text2img.py           # Text2ImageService 类
│   │   ├── img2img.py            # Image2ImageService 类
│   │   └── controlnet_manager.py # ControlNetManager 类
│   ├── optimization/
│   │   ├── __init__.py
│   │   ├── prompt_optimizer.py   # PromptOptimizer 类
│   │   └── style_presets.py      # StylePresetRegistry 类
│   ├── services/
│   │   ├── __init__.py
│   │   ├── history_service.py    # GenerationHistoryService 类
│   │   └── storage_service.py    # 输出文件存储
│   ├── ui/
│   │   ├── __init__.py
│   │   ├── layout.py             # 布局与组件组合
│   │   └── callbacks.py          # Gradio 回调函数
│   └── utils/
│       ├── __init__.py
│       ├── image_utils.py        # 图像后处理、缩略图
│       ├── model_loader.py       # 懒加载与共享权重
│       ├── cache.py              # 结果缓存、TTL 设置
│       └── logging.py            # 日志封装
├── scripts/
│   ├── download_models.py        # 模型批量下载脚本
│   └── benchmark.py              # 性能测试脚本
└── tests/
    ├── __init__.py
    ├── conftest.py
    ├── test_text2img.py
    ├── test_img2img.py
    ├── test_prompt_optimizer.py
    └── test_ui_flow.py
```

## 5. 核心模块设计与接口

### 5.1 启动与配置
- `app.py`
  - `create_app(config: AppConfig) -> gradio.Blocks`：装配 UI、注入回调。
  - `main()`：加载配置、初始化日志、启动 Gradio。
- `config/settings.py`
  - `@dataclass AppConfig`：字段包含 `model_dir`, `use_fp16`, `xformers_enabled`, `anthropic_key`, `openai_key` 等。
  - `load_config(path: str | None) -> AppConfig`：读取 `.env` 或 `secrets.yaml`，支持命令行覆盖。

### 5.2 模型推理服务
- `modules/pipelines/text2img.py`
  - `class Text2ImageService`：
    - `__init__(config: AppConfig, loader: ModelLoader)`
    - `generate(prompt: PromptRequest) -> ImageResult`
    - `set_scheduler(name: str)`：切换采样器。
  - 负责加载 `StableDiffusionPipeline`，实现 FP16/xFormers 设置。
- `modules/pipelines/img2img.py`
  - `class Image2ImageService`：
    - `generate(prompt: PromptRequest, init_image: Image, strength: float) -> ImageResult`
    - `apply_upscaling(image: Image, factor: int)`
  - 支持 ControlNet/普通 SD 联动。
- `modules/pipelines/controlnet_manager.py`
  - `class ControlNetManager`：
    - `load(model_type: ControlType) -> ControlNetModel`
    - `preprocess(image: Image, control_type: ControlType) -> torch.Tensor`
    - `available_models() -> list[str]`
  - 管理 Canny/Depth 等模型与预处理。

### 5.3 Prompt 优化与风格
- `modules/optimization/prompt_optimizer.py`
  - `class PromptOptimizer`：
    - `optimize(base_prompt: str, style: StylePreset, model: Literal["claude","gpt"]) -> PromptBundle`
    - `set_client(api: str, key: str)`
    - `health_check() -> bool`
- `modules/optimization/style_presets.py`
  - `class StylePresetRegistry`：
    - `load_from_file(path: Path) -> None`
    - `list_presets() -> list[StylePreset]`
    - `get(name: str) -> StylePreset`
  - `StylePreset` 数据结构包含 `name`, `positive`, `negative`, `cfg_scale`, `sampler` 等。

### 5.4 服务层
- `modules/services/history_service.py`
  - `class GenerationHistoryService`：
    - `record(entry: GenerationRecord) -> None`
    - `list(limit: int) -> list[GenerationRecord]`
    - `export(path: Path) -> None`
  - 采用 JSON 或 SQLite 本地存储，带清理策略。
- `modules/services/storage_service.py`
  - `class StorageService`：
    - `save_image(image: Image, metadata: dict) -> Path`
    - `cleanup(max_items: int)`
  - 负责输出目录管理与临时文件删除。

### 5.5 UI 层
- `modules/ui/layout.py`
  - `build_layout(services: ServiceContainer) -> gradio.Blocks`：组装 Tabs、Accordion、Gallery。
- `modules/ui/callbacks.py`
  - `on_generate_text(prompt, preset, guidance, steps, seed, enable_opt)`：调用 `PromptOptimizer` → `Text2ImageService`。
  - `on_generate_image(init_image, prompt, control_type, weight)`：处理图生图逻辑。
  - `on_download(history_id)`：从 `StorageService` 拉取并返回文件。
  - 所有回调注入日志、错误提示、性能计时。

### 5.6 工具层
- `modules/utils/image_utils.py`
  - `prepare_image(image: Image, target_size: tuple[int, int])`
  - `generate_thumbnail(image: Image)`
- `modules/utils/model_loader.py`
  - `class ModelLoader`：负责延迟加载、共享 Pipeline、线程锁。
  - `get_pipeline(pipeline_type: str) -> DiffusionPipeline`
- `modules/utils/cache.py`
  - `class TTLCache`：用于 Prompt 优化结果或生成历史缓存。
- `modules/utils/logging.py`
  - `setup_logging(config: AppConfig) -> logging.Logger`
  - `log_performance(event: str, duration: float, metadata: dict)`

## 6. 数据与资源准备
- **模型资源**：`scripts/download_models.py` 根据配置下载 SDXL Turbo、SD 1.5、ControlNet Canny/Depth 权重至 `models/`。
- **API 密钥**：`config/secrets.example.yaml` 提供字段示例；实际密钥存放 `.env` 或未跟踪的 `secrets.yaml`。
- **风格模板**：`assets/styles.json` 定义默认风格；同时在 `assets/prompts/` 存放示例 Prompt 集。
- **演示素材**：`assets/samples/` 规划保存不同模式下的示例图。

## 7. 开发流程与协作
- **分支策略**：`main`（稳定）、`develop`（集成）、`feature/*`（需求分支）。采用 GitHub Flow：PR 需通过 Code Review + 自动测试。
- **任务管理**：以里程碑拆分需求卡，优先级遵循核心功能 → 优化 → 文档。
- **代码规范**：遵循 `black` 风格与 `isort` 导入排序；关键模块附带类型注解与简短注释。
- **文档要求**：README 包含运行指南、功能说明、模型下载步骤；另需编写 `docs/` 内部维护手册（可于第 4 周补齐）。

## 8. 测试计划

| 测试层级 | 目标 | 工具 | 覆盖内容 |
|----------|------|------|----------|
| 单元测试 | 核心服务逻辑稳定 | `pytest` | Prompt 优化结果结构、Pipeline 参数校验、缓存与日志 |
| 集成测试 | 文生图/图生图完整链路 | `pytest`, `pytest-gradio` | API → Pipeline → 输出文件流程 |
| 性能测试 | 关键指标落盘 | 自研 `scripts/benchmark.py` | 不同分辨率耗时、显存占用 |
| 手工回归 | 演示前验证 | 检查表 | UI 交互、错误提示、历史记录、下载功能 |

测试结果统一写入 `reports/`（在第 4 周建立），并在 PR 中附执行摘要。

## 9. 性能优化与监控
- 在 `AppConfig` 中提供开关：`enable_fp16`, `enable_xformers`, `enable_vae_tiling`。
- 使用 `ModelLoader` 复用 Pipeline，避免重复加载；通过 `torch.inference_mode()` 降低开销。
- 引入 `torch.cuda.max_memory_allocated()` 指标，写入 `logs/perf.log`，便于调优。
- 提供 `benchmark.py --mode text2img --size 768` 等命令支持。

## 10. 部署与演示流程
1. 通过 `conda env export` 生成 `environment.yml`，确保可复现。
2. 在本地打包 `AI_word2picture` 目录，或准备 Dockerfile（择机）。
3. 准备演示脚本：包含文生图、图生图、Prompt 优化对比三个场景。
4. 自查清单：模型文件到位、API Key 配置、GPU 驱动版本确认、日志目录读写权限。

## 11. 风险与应对
- **显存不足**：提供降分辨率、开启 `cpu_offload`、拆分 ControlNet 的选项。
- **外部 API 不稳定**：在 `PromptOptimizer` 内缓存优化结果，支持离线模式（跳过优化）。
- **模型下载失败**：`scripts/download_models.py` 增加断点续传与校验。
- **生成质量不稳定**：收集社区高质量 Prompt，扩充风格库，并允许用户自定义。

---

> 本开发计划将在执行过程中根据评审、测试反馈动态更新。首次评审建议于第 1 周结束时进行，以确认架构与接口设计是否满足需求。
